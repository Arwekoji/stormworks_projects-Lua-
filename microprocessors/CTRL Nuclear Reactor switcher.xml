<?xml version="1.0" encoding="UTF-8"?>
<microprocessor name="CTRL (Nuclear Reactor switcher)" width="3" length="5" id_counter="193" id_counter_node="60" sym0="50195" sym1="34825" sym2="8060" sym3="2056" sym4="1040" sym6="992" sym7="448" sym8="128" sym10="128" sym12="3640" sym13="1584" sym14="33313" sym15="49155">
	<nodes>
		<n id="2" component_id="3">
			<node label="In (Control Panel)" mode="1" type="5" description="1-2nd - connect control, 3nd - valve control">
				<position x="2" z="3"/>
			</node>
		</n>
		<n id="3" component_id="6">
			<node label="Out (Control Panel)" type="5">
				<position x="2" z="2"/>
			</node>
		</n>
		<n id="34" component_id="123">
			<node label="Out (Track Speed)" type="1">
				<position z="2"/>
			</node>
		</n>
		<n id="35" component_id="124">
			<node label="Out (Controlrod level)" type="1">
				<position x="1" z="2"/>
			</node>
		</n>
		<n id="51" component_id="174">
			<node label="Out (New coolant valve)">
				<position x="1" z="1"/>
			</node>
		</n>
		<n id="52" component_id="176">
			<node label="Out (Connection Status)">
				<position z="1"/>
			</node>
		</n>
		<n id="53" component_id="190">
			<node label="Out (Remove Fuel Rod)"/>
		</n>
		<n id="54" component_id="191">
			<node label="Out (Boiler Pump)">
				<position x="1"/>
			</node>
		</n>
		<n id="55" component_id="192">
			<node label="Out (Alarm)" description="For alarm sound (P, V, R)">
				<position x="2" z="1"/>
			</node>
		</n>
		<n id="56" component_id="181">
			<node label="In (Temperature, Fuelrod)" mode="1" type="1" description="1nd channel">
				<position z="4"/>
			</node>
		</n>
		<n id="57" component_id="183">
			<node label="In (Volume, Coolant)" mode="1" type="1" description="2nd channel">
				<position x="2" z="4"/>
			</node>
		</n>
		<n id="58" component_id="185">
			<node label="In (Volume, Boiler)" mode="1" type="1">
				<position x="1" z="4"/>
			</node>
		</n>
		<n id="59" component_id="187">
			<node label="In (Pressure, Boiler)" mode="1" type="1">
				<position x="1" z="3"/>
			</node>
		</n>
		<n id="60" component_id="189">
			<node label="In (Radiation)" mode="1" type="1">
				<position z="3"/>
			</node>
		</n>
	</nodes>
	<group>
		<data>
			<inputs/>
			<outputs/>
		</data>
		<components>
			<c type="56">
				<object id="29" script="alarm_rad      = 8
alarm_pressure = 100--9.4
alarm_volume   = -1--20



system_cooldown = false
flag_highT = false
flag_highR = false
function CheckCooldownSystem(T, T_max, T_min, rad)
	if system_cooldown == false then
		if T &gt; T_max then
			system_cooldown = true
			flag_highT = true
		end
		if rad &gt; 5 then
			system_cooldown = true
			flag_highR = true
		end
	else
		checkT = false
		checkR = false
		if flag_highT==true and T&gt;T_min then
			checkT = true
		end
		if flag_highR==true and rad&gt;1 then
			checkR = true
		end
		system_cooldown = checkT or checkR
	end
	
	return system_cooldown
end


function Alarm(rad, danger_R, boiler_volume, danger_V, pressure, danger_P)
	local alarm = false
	if rad&gt;danger_R   or   boiler_volume &lt; danger_V   or   pressure &gt; danger_P then
		alarm = true
	end
	return alarm
end


blink_counter = 0
function Blink(sec_on, sec_off)
	blink_counter = blink_counter + 1
	if blink_counter&gt;(sec_on*60) then	
		blink_counter = -1*60*sec_off
	end
end


current_status = -2	-- -2 - passive off, -1 - removing, 1 - connecting, 2 - passive on
function RodConnectionIndicator(seconds_on, seconds_off) --current status indicator on control panel
	CI = false
	if (math.abs(current_status) == 1 and blink_counter &gt; 0) or current_status == 2 then 
		CI = true
	end
	Blink(seconds_on,seconds_off)
	return CI
end


function Number2PrebinaryScale(number, maxnum) --Nothing like 01101110, only 00011111
	num_sections = number // (maxnum/8)
	prebinary = 0
	for i=0, num_sections do
		prebinary = prebinary + 2^i
	end
	return prebinary
end


function Ticks2Time(ticks, time_mod) --1=seconds, 2=minutes, 3=hours, 4=days
	div = 60^math.max(0, math.min(time_mod, 3))
	if time_mod==4 then
		div = div*24
	end
	return math.floor(ticks/div)
end


fuel_timer = 0
function onTick() 
	------------------------------------ INPUTS
	command_connect = input.getBool(1)
	command_remove  = input.getBool(2)
	control_valve   = input.getBool(3)
	rod_temp	    = input.getNumber(1)
	cool_volume 	= input.getNumber(2)
	boiler_volume   = input.getNumber(3)
	pressure        = input.getNumber(4)
	radiation  	 = input.getNumber(5)
	temp_min	= math.min(input.getNumber(6), input.getNumber(7))
	temp_max	= math.max(input.getNumber(6), input.getNumber(7))
	------------------------------------ OUTPUTS
	track_speed = 0     --1
	removing    = false --32
	pump		= false
	------------------------------------ local variables
	control_rod = 0--math.min(100, (math.max(rod_temp, 100)-100))/100
	if rod_temp &gt; 100 then
		control_rod = 1
	end
	
	
	--++++++++++++++++++++++++++++++++++
	if current_status==-2 then
		if command_connect==true then
			current_status = 1
		else
			track_speed = 0
			removing = true
		end	
	end
	
	if current_status==-1 then
		if command_connect==true then
			current_status = 1
		else
			track_speed = -1
			removing = true
			if rod_temp == 0 and command_remove~=true then
				current_status = -2
			end	
		end	
	end
	
	if current_status==1 then
		if command_remove==true then
			current_status = -1
		else 
			if system_cooldown ~= true then
				track_speed = 1
				removing = false
				if rod_temp ~= 0 then
					current_status = 2
				end	
			end
		end	
	end
	
	if current_status==2 then
		if command_remove==true then
			current_status = -1
		else
			track_speed = 0
			removing = false
			fuel_timer = fuel_timer+1
		end	
	end
	--++++++++++++++++++++++++++++++++++
	
	CheckCooldownSystem(rod_temp, temp_max, temp_min, radiation) --too low pressure for efficiency, unblock when game will be fix and fix code
	
	--++++++++++++++++++++++++++++++++++	Cool down the system
	if system_cooldown==true and current_status &gt; 0 then
		track_speed = -1
		removing = true
		current_status = 1
	end
	--++++++++++++++++++++++++++++++++++
	
	if boiler_volume &lt; 170 then
		pump = true
	end
	
	
	----------------
	--Composite display
	output.setNumber(1, 9-Ticks2Time(fuel_timer, 3))
	output.setNumber(2, cool_volume)
	output.setBool(3, control_valve)
	----------------
	
	
	output.setNumber(31, track_speed)
	output.setNumber(32, control_rod)
	
	output.setBool(29, RodConnectionIndicator(1, 1))
	output.setBool(30, removing)
	output.setBool(31, pump)	
	output.setBool(32, Alarm(radiation, alarm_rad, boiler_volume, alarm_volume, pressure, alarm_pressure))	
end
">
					<pos x="3" y="-1"/>
					<in1 component_id="30"/>
				</object>
			</c>
			<c type="40">
				<object id="30" count="7">
					<pos x="1.75" y="-2.5"/>
					<inc component_id="3"/>
					<in1 component_id="181"/>
					<in2 component_id="183"/>
					<in3 component_id="185"/>
					<in4 component_id="187"/>
					<in5 component_id="189"/>
					<in6 component_id="73"/>
					<in7 component_id="74"/>
				</object>
			</c>
			<c type="34">
				<object id="73" n="Min Temp">
					<pos x="-0.75" y="-2.25"/>
					<v text="200" value="200"/>
				</object>
			</c>
			<c type="34">
				<object id="74" n="Max Temp">
					<pos x="-0.75" y="-2.5"/>
					<v text="1000" value="1000"/>
				</object>
			</c>
			<c type="31">
				<object id="147" i="30">
					<pos x="5" y="-1.25"/>
					<in1 component_id="29"/>
				</object>
			</c>
			<c type="31">
				<object id="148" i="31">
					<pos x="5" y="-1.75"/>
					<in1 component_id="29"/>
				</object>
			</c>
			<c type="29">
				<object id="165" i="2">
					<pos x="5" y="-2.25"/>
					<in1 component_id="29"/>
				</object>
			</c>
			<c type="29">
				<object id="166" i="28">
					<pos x="5" y="-2.75"/>
					<in1 component_id="29"/>
				</object>
			</c>
			<c type="29">
				<object id="167" i="29">
					<pos x="5" y="-3.25"/>
					<in1 component_id="29"/>
				</object>
			</c>
			<c type="29">
				<object id="168" i="30">
					<pos x="5" y="-3.75"/>
					<in1 component_id="29"/>
				</object>
			</c>
			<c type="29">
				<object id="193" i="31">
					<pos x="5" y="-4.25"/>
					<in1 component_id="29"/>
				</object>
			</c>
		</components>
		<components_bridge>
			<c type="4">
				<object id="3">
					<pos x="0.25" y="-0.75"/>
				</object>
			</c>
			<c type="5">
				<object id="6">
					<pos x="7" y="-0.75"/>
					<in1 component_id="29"/>
				</object>
			</c>
			<c type="3">
				<object id="123">
					<pos x="7" y="-1.25"/>
					<in1 component_id="147"/>
				</object>
			</c>
			<c type="3">
				<object id="124">
					<pos x="7" y="-1.75"/>
					<in1 component_id="148"/>
				</object>
			</c>
			<c type="1">
				<object id="174">
					<pos x="7" y="-2.25"/>
					<in1 component_id="165"/>
				</object>
			</c>
			<c type="1">
				<object id="176">
					<pos x="7" y="-2.75"/>
					<in1 component_id="166"/>
				</object>
			</c>
			<c type="2">
				<object id="181">
					<pos x="0.25" y="-1"/>
				</object>
			</c>
			<c type="2">
				<object id="183">
					<pos x="0.25" y="-1.25"/>
				</object>
			</c>
			<c type="2">
				<object id="185">
					<pos x="0.25" y="-1.5"/>
				</object>
			</c>
			<c type="2">
				<object id="187">
					<pos x="0.25" y="-1.75"/>
				</object>
			</c>
			<c type="2">
				<object id="189">
					<pos x="0.25" y="-2"/>
				</object>
			</c>
			<c type="1">
				<object id="190">
					<pos x="7" y="-3.25"/>
					<in1 component_id="167"/>
				</object>
			</c>
			<c type="1">
				<object id="191">
					<pos x="7" y="-3.75"/>
					<in1 component_id="168"/>
				</object>
			</c>
			<c type="1">
				<object id="192">
					<pos x="7" y="-4.25"/>
					<in1 component_id="193"/>
				</object>
			</c>
		</components_bridge>
		<groups/>
		<component_states>
			<c0 id="29" script="alarm_rad      = 8
alarm_pressure = 100--9.4
alarm_volume   = -1--20



system_cooldown = false
flag_highT = false
flag_highR = false
function CheckCooldownSystem(T, T_max, T_min, rad)
	if system_cooldown == false then
		if T &gt; T_max then
			system_cooldown = true
			flag_highT = true
		end
		if rad &gt; 5 then
			system_cooldown = true
			flag_highR = true
		end
	else
		checkT = false
		checkR = false
		if flag_highT==true and T&gt;T_min then
			checkT = true
		end
		if flag_highR==true and rad&gt;1 then
			checkR = true
		end
		system_cooldown = checkT or checkR
	end
	
	return system_cooldown
end


function Alarm(rad, danger_R, boiler_volume, danger_V, pressure, danger_P)
	local alarm = false
	if rad&gt;danger_R   or   boiler_volume &lt; danger_V   or   pressure &gt; danger_P then
		alarm = true
	end
	return alarm
end


blink_counter = 0
function Blink(sec_on, sec_off)
	blink_counter = blink_counter + 1
	if blink_counter&gt;(sec_on*60) then	
		blink_counter = -1*60*sec_off
	end
end


current_status = -2	-- -2 - passive off, -1 - removing, 1 - connecting, 2 - passive on
function RodConnectionIndicator(seconds_on, seconds_off) --current status indicator on control panel
	CI = false
	if (math.abs(current_status) == 1 and blink_counter &gt; 0) or current_status == 2 then 
		CI = true
	end
	Blink(seconds_on,seconds_off)
	return CI
end


function Number2PrebinaryScale(number, maxnum) --Nothing like 01101110, only 00011111
	num_sections = number // (maxnum/8)
	prebinary = 0
	for i=0, num_sections do
		prebinary = prebinary + 2^i
	end
	return prebinary
end


function Ticks2Time(ticks, time_mod) --1=seconds, 2=minutes, 3=hours, 4=days
	div = 60^math.max(0, math.min(time_mod, 3))
	if time_mod==4 then
		div = div*24
	end
	return math.floor(ticks/div)
end


fuel_timer = 0
function onTick() 
	------------------------------------ INPUTS
	command_connect = input.getBool(1)
	command_remove  = input.getBool(2)
	control_valve   = input.getBool(3)
	rod_temp	    = input.getNumber(1)
	cool_volume 	= input.getNumber(2)
	boiler_volume   = input.getNumber(3)
	pressure        = input.getNumber(4)
	radiation  	 = input.getNumber(5)
	temp_min	= math.min(input.getNumber(6), input.getNumber(7))
	temp_max	= math.max(input.getNumber(6), input.getNumber(7))
	------------------------------------ OUTPUTS
	track_speed = 0     --1
	removing    = false --32
	pump		= false
	------------------------------------ local variables
	control_rod = 0--math.min(100, (math.max(rod_temp, 100)-100))/100
	if rod_temp &gt; 100 then
		control_rod = 1
	end
	
	
	--++++++++++++++++++++++++++++++++++
	if current_status==-2 then
		if command_connect==true then
			current_status = 1
		else
			track_speed = 0
			removing = true
		end	
	end
	
	if current_status==-1 then
		if command_connect==true then
			current_status = 1
		else
			track_speed = -1
			removing = true
			if rod_temp == 0 and command_remove~=true then
				current_status = -2
			end	
		end	
	end
	
	if current_status==1 then
		if command_remove==true then
			current_status = -1
		else 
			if system_cooldown ~= true then
				track_speed = 1
				removing = false
				if rod_temp ~= 0 then
					current_status = 2
				end	
			end
		end	
	end
	
	if current_status==2 then
		if command_remove==true then
			current_status = -1
		else
			track_speed = 0
			removing = false
			fuel_timer = fuel_timer+1
		end	
	end
	--++++++++++++++++++++++++++++++++++
	
	CheckCooldownSystem(rod_temp, temp_max, temp_min, radiation) --too low pressure for efficiency, unblock when game will be fix and fix code
	
	--++++++++++++++++++++++++++++++++++	Cool down the system
	if system_cooldown==true and current_status &gt; 0 then
		track_speed = -1
		removing = true
		current_status = 1
	end
	--++++++++++++++++++++++++++++++++++
	
	if boiler_volume &lt; 170 then
		pump = true
	end
	
	
	----------------
	--Composite display
	output.setNumber(1, 9-Ticks2Time(fuel_timer, 3))
	output.setNumber(2, cool_volume)
	output.setBool(3, control_valve)
	----------------
	
	
	output.setNumber(31, track_speed)
	output.setNumber(32, control_rod)
	
	output.setBool(29, RodConnectionIndicator(1, 1))
	output.setBool(30, removing)
	output.setBool(31, pump)	
	output.setBool(32, Alarm(radiation, alarm_rad, boiler_volume, alarm_volume, pressure, alarm_pressure))	
end
">
				<pos x="3" y="-1"/>
				<in1 component_id="30"/>
			</c0>
			<c1 id="30" count="7">
				<pos x="1.75" y="-2.5"/>
				<inc component_id="3"/>
				<in1 component_id="181"/>
				<in2 component_id="183"/>
				<in3 component_id="185"/>
				<in4 component_id="187"/>
				<in5 component_id="189"/>
				<in6 component_id="73"/>
				<in7 component_id="74"/>
			</c1>
			<c2 id="73" n="Min Temp">
				<pos x="-0.75" y="-2.25"/>
				<v text="200" value="200"/>
			</c2>
			<c3 id="74" n="Max Temp">
				<pos x="-0.75" y="-2.5"/>
				<v text="1000" value="1000"/>
			</c3>
			<c4 id="147" i="30">
				<pos x="5" y="-1.25"/>
				<in1 component_id="29"/>
			</c4>
			<c5 id="148" i="31">
				<pos x="5" y="-1.75"/>
				<in1 component_id="29"/>
			</c5>
			<c6 id="165" i="2">
				<pos x="5" y="-2.25"/>
				<in1 component_id="29"/>
			</c6>
			<c7 id="166" i="28">
				<pos x="5" y="-2.75"/>
				<in1 component_id="29"/>
			</c7>
			<c8 id="167" i="29">
				<pos x="5" y="-3.25"/>
				<in1 component_id="29"/>
			</c8>
			<c9 id="168" i="30">
				<pos x="5" y="-3.75"/>
				<in1 component_id="29"/>
			</c9>
			<c10 id="193" i="31">
				<pos x="5" y="-4.25"/>
				<in1 component_id="29"/>
			</c10>
		</component_states>
		<component_bridge_states>
			<c0 id="3">
				<pos x="0.25" y="-0.75"/>
			</c0>
			<c1 id="6">
				<pos x="7" y="-0.75"/>
				<in1 component_id="29"/>
			</c1>
			<c2 id="123">
				<pos x="7" y="-1.25"/>
				<in1 component_id="147"/>
			</c2>
			<c3 id="124">
				<pos x="7" y="-1.75"/>
				<in1 component_id="148"/>
			</c3>
			<c4 id="174">
				<pos x="7" y="-2.25"/>
				<in1 component_id="165"/>
			</c4>
			<c5 id="176">
				<pos x="7" y="-2.75"/>
				<in1 component_id="166"/>
			</c5>
			<c6 id="181">
				<pos x="0.25" y="-1"/>
			</c6>
			<c7 id="183">
				<pos x="0.25" y="-1.25"/>
			</c7>
			<c8 id="185">
				<pos x="0.25" y="-1.5"/>
			</c8>
			<c9 id="187">
				<pos x="0.25" y="-1.75"/>
			</c9>
			<c10 id="189">
				<pos x="0.25" y="-2"/>
			</c10>
			<c11 id="190">
				<pos x="7" y="-3.25"/>
				<in1 component_id="167"/>
			</c11>
			<c12 id="191">
				<pos x="7" y="-3.75"/>
				<in1 component_id="168"/>
			</c12>
			<c13 id="192">
				<pos x="7" y="-4.25"/>
				<in1 component_id="193"/>
			</c13>
		</component_bridge_states>
		<group_states/>
	</group>
</microprocessor>

